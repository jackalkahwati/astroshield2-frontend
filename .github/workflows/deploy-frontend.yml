name: Deploy Frontend

on:
  push:
    branches: [ main ]
    paths: 
      - 'frontend/**'
      - 'components/**'
      - 'app/**'
      - 'src/**'
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸŽ¨ Deploy Frontend to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          echo "ðŸŽ¨ Starting AstroShield Frontend Deployment..."
          
          # Navigate to the project directory
          cd ${{ secrets.EC2_PROJECT_PATH }} || {
            echo "âŒ Project directory not found at ${{ secrets.EC2_PROJECT_PATH }}"
            exit 1
          }
          
          # Pull latest changes
          echo "ðŸ”„ Pulling latest changes..."
          git pull origin main
          
          # Rebuild just the frontend service
          echo "ðŸ—ï¸ Rebuilding frontend service..."
          docker-compose -f docker-compose.fullstack.yml up -d --build frontend
          
          # Wait for frontend to be ready
          echo "â³ Waiting for frontend to start..."
          sleep 10
          
          # Check if frontend is running
          if docker-compose -f docker-compose.fullstack.yml ps frontend | grep -q "Up"; then
            echo "âœ… Frontend deployment successful!"
          else
            echo "âŒ Frontend deployment failed!"
            docker-compose -f docker-compose.fullstack.yml logs frontend
            exit 1
          fi
          
          echo "ðŸŽ‰ Frontend deployment complete!"

    - name: ðŸ“ Frontend Deployment Summary
      if: success()
      run: |
        echo "## ðŸŽ¨ Frontend Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "- **Target**: AstroShield Frontend (Next.js)" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://astroshield.sdataplab.com/" >> $GITHUB_STEP_SUMMARY
        echo "- **Service**: Frontend container rebuilt" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY 